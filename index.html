<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel Administrativo ‚Äî Magaxia</title>

<style>
  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#f2f5fa;
    color:#000;
    padding:20px;
  }
  h2{ text-align:center; }
  .box{
    background:#fff;
    padding:15px;
    border-radius:10px;
    box-shadow:0 3px 12px rgba(0,0,0,.1);
    margin-bottom:20px;
  }
  table{
    width:100%;
    border-collapse:collapse;
  }
  th,td{
    padding:8px;
    border-bottom:1px solid #ddd;
  }
  button{
    padding:8px 12px;
    border:none;
    background:#4da3ff;
    border-radius:8px;
    cursor:pointer;
    color:#000;
    font-weight:bold;
  }
  button:hover{ background:#1f89ff; }
</style>
</head>
<body>

<h2>Painel Administrativo</h2>

<!-- üî• SDK DO FIREBASE (ORDEM OBRIGAT√ìRIA) -->
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

<!-- üî• SEU ARQUIVO firebase.js (tem que estar na mesma pasta) -->
<script src="firebase.js"></script>

<div id="noAccess" style="display:none; text-align:center;">
  <p><b>‚ö† Acesso restrito.</b></p>
  <p>Fa√ßa login com uma conta admin.</p>
  <button id="btnLogin">Entrar</button>
</div>

<div id="adminArea" style="display:none">

  <!-- PRODUTOS -->
  <div class="box">
    <h3>Produtos</h3>

    <input id="pNome" placeholder="Nome do produto"><br><br>
    <input id="pValor" placeholder="Valor" type="number"><br><br>
    <input id="pRenda" placeholder="Renda di√°ria" type="number"><br><br>
    <input id="pImg" placeholder="URL da imagem (opcional)"><br><br>

    <button id="btnAddProd">Adicionar Produto</button>

    <h4>Lista de Produtos</h4>
    <div id="prodList">Carregando...</div>
  </div>

  <!-- USU√ÅRIOS -->
  <div class="box">
    <h3>Usu√°rios</h3>
    <div id="userList">Carregando...</div>
  </div>

  <!-- SAQUES -->
  <div class="box">
    <h3>Saques Pendentes</h3>
    <div id="saquesList">Carregando...</div>
  </div>

</div>


<script>
/* ========================================================
      VERIFICA√á√ÉO DE ADMIN / LOGIN / AUTH STATE
========================================================= */

const adminArea = document.getElementById('adminArea');
const noAccess = document.getElementById('noAccess');

auth.onAuthStateChanged(async user => {
  console.log("USER:", user);

  if(!user){
    noAccess.style.display = "block";
    adminArea.style.display = "none";
    return;
  }

  const permitido = await isAdmin(user.uid);
  console.log("√â ADMIN?", permitido);

  if(!permitido){
    noAccess.style.display = "block";
    adminArea.style.display = "none";
    return;
  }

  noAccess.style.display = "none";
  adminArea.style.display = "block";
  iniciarPainel();
});

/* LOGIN */
document.getElementById("btnLogin").onclick = async () => {
  const email = prompt("Email do admin:");
  const senha = prompt("Senha:");
  
  try {
    await auth.signInWithEmailAndPassword(email, senha);
  } catch(e){
    alert("Erro: " + e.message);
  }
};


/* ========================================================
                  FUN√á√ïES DO PAINEL
========================================================= */

function iniciarPainel(){
  carregarProdutos();
  carregarUsuarios();
  carregarSaques();
}


/* ---------------------- PRODUTOS ---------------------- */
document.getElementById("btnAddProd").onclick = async () => {
  const nome = pNome.value.trim();
  const valor = Number(pValor.value);
  const renda = Number(pRenda.value);
  const img = pImg.value.trim();

  if(!nome || !valor || !renda){
    alert("Preencha todos os campos!");
    return;
  }

  await db.collection("produtos").add({
    nome, valor, renda, img,
    criadoEm: firebase.firestore.FieldValue.serverTimestamp()
  });

  pNome.value = "";
  pValor.value = "";
  pRenda.value = "";
  pImg.value = "";

  carregarProdutos();
};

async function carregarProdutos(){
  const snap = await db.collection("produtos").orderBy("criadoEm","desc").get();

  if(snap.empty){
    prodList.innerHTML = "Nenhum produto cadastrado.";
    return;
  }

  prodList.innerHTML = `
    <table>
      <tr><th>Nome</th><th>Valor</th><th>Renda</th><th>A√ß√£o</th></tr>
      ${
        snap.docs.map(doc => {
          const p = doc.data();
          return `
            <tr>
              <td>${p.nome}</td>
              <td>R$${p.valor}</td>
              <td>R$${p.renda}</td>
              <td><button onclick="delProduto('${doc.id}')">Excluir</button></td>
            </tr>
          `;
        }).join("")
      }
    </table>
  `;
}

window.delProduto = async function(id){
  if(!confirm("Excluir produto?")) return;
  await db.collection("produtos").doc(id).delete();
  carregarProdutos();
};


/* ---------------------- USU√ÅRIOS ---------------------- */

async function carregarUsuarios(){
  const snap = await db.collection("usuarios").orderBy("createdAt","desc").get();

  if(snap.empty){
    userList.innerHTML = "Nenhum usu√°rio encontrado.";
    return;
  }

  userList.innerHTML = `
    <table>
      <tr><th>Email</th><th>Saldo</th><th>A√ß√£o</th></tr>
      ${
        snap.docs.map(doc => {
          const u = doc.data();
          return `
            <tr>
              <td>${u.email}</td>
              <td>R$${Number(u.saldo||0).toFixed(2)}</td>
              <td><button onclick="mudarSaldo('${doc.id}')">Ajustar saldo</button></td>
            </tr>
          `;
        }).join("")
      }
    </table>
  `;
}

window.mudarSaldo = async function(uid){
  const novo = prompt("Novo saldo:");
  const n = Number(novo);
  if(isNaN(n)) return alert("Valor inv√°lido.");
  
  await db.collection("usuarios").doc(uid).update({ saldo:n });
  carregarUsuarios();
};


/* ---------------------- SAQUES ---------------------- */

async function carregarSaques(){
  const snap = await db.collection("saques").where("status","==","pendente").get();

  if(snap.empty){
    saquesList.innerHTML = "Nenhum saque pendente.";
    return;
  }

  saquesList.innerHTML = `
    <table>
      <tr><th>Usu√°rio</th><th>Valor</th><th>Data</th><th>A√ß√£o</th></tr>
      ${snap.docs.map(doc => {
        const s = doc.data();
        return `
          <tr>
            <td>${s.uid}</td>
            <td>R$${s.valor} (taxa R$${s.taxa})</td>
            <td>${s.createdAt ? s.createdAt.toDate().toLocaleString("pt-BR") : ""}</td>
            <td>
              <button onclick="aprovarSaque('${doc.id}','${s.uid}','${s.valor}')">Aprovar</button>
              <button onclick="rejeitarSaque('${doc.id}')">Rejeitar</button>
            </td>
          </tr>
        `;
      }).join("")}
    </table>
  `;
}

window.aprovarSaque = async function(id, uid, valor){
  if(!confirm("Aprovar este saque?")) return;

  const refUser = db.collection("usuarios").doc(uid);
  const refSaque = db.collection("saques").doc(id);

  await db.runTransaction(async tx => {
    const snapUser = await tx.get(refUser);
    const saldo = Number(snapUser.data().saldo || 0);
    const total = Number(valor) + 5;

    if(saldo < total) throw "Saldo insuficiente.";

    tx.update(refUser, { saldo: saldo - total });
    tx.update(refSaque, { status:"aprovado" });
  });

  alert("Saque aprovado!");
  carregarSaques();
  carregarUsuarios();
};

window.rejeitarSaque = async function(id){
  if(!confirm("Rejeitar?")) return;

  await db.collection("saques").doc(id).update({ status:"rejeitado" });
  carregarSaques();
};
</script>

</body>
</html>
